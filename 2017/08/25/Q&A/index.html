<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Q&amp;A | caster zone</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Q&amp;A</h1><a id="logo" href="/.">caster zone</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> archives</i></a><a href="/coding/"><i class="fa fa-code"> coding</i></a><a href="/about-me/"><i class="fa fa-user"> about me</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Q&amp;A</h1><div class="post-meta">Aug 25, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><!-- toc -->
<ul>
<li><a href="#questionanwsers">Question&amp;Anwsers:</a><ul>
<li><a href="#使用linux-epoll模型水平触发模式level-triggered当socket可写时会不停的触发socket可写的事件如何处理">使用Linux epoll模型，水平触发模式（Level-Triggered）；当socket可写时，会不停的触发socket可写的事件，如何处理？</a></li>
<li><a href="#从socket读数据时socket缓存里的数据可能超过用户缓存的长度如何处理-例如socket缓存有8kb的数据而你的缓存只有2kb空间">从socket读数据时，socket缓存里的数据，可能超过用户缓存的长度，如何处理？ 例如，socket缓存有8kB的数据，而你的缓存只有2kB空间。</a></li>
<li><a href="#向socket发送数据时-可能只发送了用户缓存里的一半如何处理例如需要向socket发送8kb数据返回值只有2kb发送成功">向socket发送数据时， 可能只发送了用户缓存里的一半，如何处理？例如，需要向socket发送8kB数据，返回值只有2kB发送成功。</a></li>
<li><a href="#非阻塞connect如何实现">非阻塞connect（）如何实现？</a></li>
<li><a href="#sizeof问题">sizeof()问题</a></li>
<li><a href="#实现字符串比较函数-strcmpchar-src-char-sub">实现字符串比较函数 strcmp(char <em>src, char </em> sub)*</a></li>
<li><a href="#实现内存拷贝函数-strcpyvoiddst-char-src-size_t-len">实现内存拷贝函数 strcpy(void<em>dst, char </em> src, size_t len)</a></li>
<li><a href="#条件变量的如何使用-你使用的线程函数是什么">条件变量的如何使用? 你使用的线程函数是什么？</a></li>
<li><a href="#deamon进程如何实现">deamon进程如何实现</a></li>
<li><a href="#http和cgi是什么">HTTP和CGI是什么?</a></li>
<li><a href="#tcp的三次握手-time_wait和close_wait状态是什么">TCP的三次握手， TIME_WAIT和CLOSE_WAIT状态是什么？</a></li>
<li><a href="#linux-命令">Linux 命令</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<a id="more"></a>
<h3><span id="questionampanwsers">Question&amp;Anwsers:</span></h3><ol>
<li><h5><span id="使用linux-epoll模型水平触发模式level-triggered当socket可写时会不停的触发socket可写的事件如何处理">使用Linux epoll模型，水平触发模式（Level-Triggered）；当socket可写时，会不停的触发socket可写的事件，如何处理？</span></h5><blockquote>
<p>第一种最普通的方式：</p>
<p>​    当需要向socket写数据时，将该socket加入到epoll模型（epoll_ctl）；等待可写事件。</p>
<p>​    接收到socket可写事件后，调用write()或send()发送数据。 </p>
<p>​        当数据全部写完后， 将socket描述符移出epoll模型。</p>
<p>​        这种方式的缺点是：  即使发送很少的数据，也要将socket加入、移出epoll模型。有一定的操作代价。</p>
<p>第二种方式，（是本人的改进方案， 叫做directly-write）</p>
<p>​        向socket写数据时，不将socket加入到epoll模型；而是直接调用send()发送；</p>
<pre><code>只有当或send()返回错误码EAGAIN（系统缓存满），才将socket加入到epoll模型，等待可写事件后，再发送数据。
</code></pre><p>​        全部数据发送完毕，再移出epoll模型。</p>
<p>​         这种方案的优点：   当用户数据比较少时，不需要epool的事件处理。 </p>
<p>​         在高压力的情况下，性能怎么样呢？   </p>
<p>​          对一次性直接写成功、失败的次数进行统计。如果成功次数远大于失败的次数， 说明性能良好。（如果失败次数远大于成功的次数，则关闭这种直接写的操作，改用第一种方案。同时在日志里记录警告）</p>
<p>​         在我自己的应用系统中，实验结果数据证明该方案的性能良好。</p>
<p>​     </p>
<p>​        事实上，网络数据可分为两种到达/发送情况：</p>
<p>​         一是分散的数据包， 例如每间隔40ms左右，发送/接收3-5个 MTU（或更小，这样就没超过默认的8K系统缓存）。</p>
<p>​         二是连续的数据包， 例如每间隔1s左右，连续发送/接收 20个 MTU（或更多）。</p>
<p>​</p>
<p>回来查了资料，发现以下两种方式：</p>
<p>第三种方式：</p>
<p>​    使用Edge-Triggered（边沿触发），这样socket有可写事件，只会触发一次。可以在应用层做好标记。以避免频繁的调用 epoll_ctl( EPOLL_CTL_ADD, EPOLL_CTL_MOD)。  这种方式是epoll 的 man 手册里推荐的方式， 性能最高。但如果处理不当容易出错，事件驱动停止。</p>
<p>第四种方式：  </p>
<p>​    在epoll_ctl()使用EPOLLONESHOT标志，当事件触发以后，socket会被禁止再次触发。需要再次调用epoll_ctl（EPOLL_CTL_MOD），才会接收下一次事件。   这种方式可以禁止socket可写事件，应该也会同时禁止可读事件。会带来不便，同时并没有性能优势，因为epoll_ctl（）有一定的操作代价。</p>
</blockquote>
</li>
</ol>
<ol>
<li><h5><span id="从socket读数据时socket缓存里的数据可能超过用户缓存的长度如何处理-例如socket缓存有8kb的数据而你的缓存只有2kb空间">从socket读数据时，socket缓存里的数据，可能超过用户缓存的长度，如何处理？ 例如，socket缓存有8kB的数据，而你的缓存只有2kB空间。</span></h5><blockquote>
<p>可以调用realloc()，扩大原有的缓存块尺寸。 但是临时申请内存的有一定性能损失。</p>
<p>这种情况要看接收缓存的方式。</p>
<p>第一种方式：  使用100k的大接收缓存为例。 如果要等待数据，并进行解析。可能发生缓存不够的情况。此时只能扩充缓存，或先处理100k的数据，再接收新的数据。</p>
<p>第二种方式： 使用缓存队列，分成8K大小的队列。不存在接收缓存不够的情况。 除非用户解析已出错，使用数据接收、使用脱勾。</p>
<p>这种方式的代价是，可能需要将缓存队列再次拷贝、拼接成一块大的缓存，再进行解析。</p>
<p>而在本人的系统中，只需要将socket接收的数据再次原样分发给客户， 所以这种方案是最佳方案。</p>
</blockquote>
</li>
<li><h5><span id="向socket发送数据时-可能只发送了用户缓存里的一半如何处理例如需要向socket发送8kb数据返回值只有2kb发送成功">向socket发送数据时， 可能只发送了用户缓存里的一半，如何处理？例如，需要向socket发送8kB数据，返回值只有2kB发送成功。</span></h5><blockquote>
<p>记录缓存的偏移量。 下一次socket写事件时， 再从偏移的位置接着发送。</p>
</blockquote>
</li>
<li><h5><span id="非阻塞connect如何实现">非阻塞connect（）如何实现？</span></h5><blockquote>
<p>将socket设置成non-blocking，操作方法同非阻塞read()、write();</p>
</blockquote>
</li>
<li><h5><span id="sizeof问题">sizeof()问题</span></h5><p>##### </p>
</li>
<li><h5><span id="实现字符串比较函数-strcmpchar-src-char-sub">实现字符串比较函数  strcmp(char <em>src, char </em> sub)*</span></h5><p>##### </p>
</li>
<li><h5><span id="实现内存拷贝函数-strcpyvoiddst-char-src-size_t-len">实现内存拷贝函数  strcpy(void<em>dst, char </em> src, size_t len)</span></h5><blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; assert(dst!=<span class="literal">NULL</span>);</div><div class="line">&gt; assert(src!=<span class="literal">NULL</span>);</div><div class="line">&gt; <span class="keyword">while</span>((*dst++=*src++)!=‘\<span class="number">0</span>’);</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
</li>
<li><h5><span id="条件变量的如何使用-你使用的线程函数是什么">条件变量的如何使用? 你使用的线程函数是什么？</span></h5><p>##### </p>
</li>
<li><h5><span id="deamon进程如何实现">deamon进程如何实现</span></h5><p>##### </p>
</li>
<li><h5><span id="http和cgi是什么">HTTP和CGI是什么?</span></h5><p>##### </p>
</li>
<li><h5><span id="tcp的三次握手-time_wait和close_wait状态是什么">TCP的三次握手， TIME_WAIT和CLOSE_WAIT状态是什么？</span></h5></li>
</ol>
<ol>
<li><h5><span id="linux-命令">Linux 命令</span></h5><blockquote>
<ol>
<li>netstat </li>
</ol>
<ol>
<li>tcpdump</li>
</ol>
<p>​</p>
<ol>
<li>ipcs</li>
</ol>
<p>​</p>
<ol>
<li>ipcrm</li>
</ol>
<p>查看 cpu 信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> $cat /proc/cpuinfo</div><div class="line"><span class="meta">&gt;</span> $cat /proc/meminfo</div><div class="line"><span class="meta">&gt;</span></div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>查看硬盘信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> $df -lh</div><div class="line"><span class="meta">&gt;</span></div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>更详细的信息</p>
<p>​        # cat /proc/scsi/scsi</p>
<p>查看网卡信息</p>
<p>​        # dmesg | grep eth</p>
<p>更常用的命令 ( 显示系统核心版本号、名称、机器类型等 )</p>
<p>​        # uname -a</p>
<p>​</p>
</blockquote>
</li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/08/25/entry/" class="next">entry</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/c/" style="font-size: 15px;">c</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/Q&A/">Q&A</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/entry/">entry</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/mailRFC/">mailRFC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/sed/">sed</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/内核学习笔记/">内核学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/后台开发实践/">后台开发实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/学习笔记/">学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/语法笔记/">语法笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/C_Learning/">c 语言陷阱与缺陷</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/Mycaster" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">caster zone.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>